<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¦Šç‹äº†ä¸ªç‹—ğŸ¶</title>
    <style>
        :root {
            --bg-color: #81d8d0; /* Tiffany ç»¿ */
            --accent-color: #0fa3b1;
            --tile-bg: #fff;
            --slot-bg: rgba(255, 255, 255, 0.2);
            --disabled: rgba(0,0,0,0.25);
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            color: #0f2e2e;
            background-image: radial-gradient(circle, #a6ede4 1px, transparent 1px);
            background-size: 20px 20px;
        }

        h1 {
            margin-top: 12px;
            text-shadow: 0 0 10px rgba(255,255,255,0.4);
            font-size: 2.1rem;
        }

        .hud {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 10px;
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            backdrop-filter: blur(6px);
        }

        .score {
            font-size: 1rem;
            letter-spacing: 1px;
        }

        .level-tag {
            font-size: 0.95rem;
            padding: 4px 10px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.25);
            border-radius: 10px;
        }

        .restart-btn {
            padding: 8px 16px;
            font-size: 1rem;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 30;
        }

        .restart-btn:hover { transform: translateY(-1px); }

        .restart-btn-fixed {
            position: fixed;
            top: 16px;
            right: 16px;
        }

        .tool-btn {
            padding: 8px 16px;
            font-size: 1rem;
            background: #fff;
            color: var(--accent-color);
            border: 1px solid rgba(15,163,177,0.35);
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, background 0.2s, color 0.2s, opacity 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.12);
        }

        .tool-btn:hover { transform: translateY(-1px); }

        .tool-btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
            color: var(--disabled);
            border-color: var(--disabled);
        }

        /* åº•éƒ¨æ§½ä½åŒºåŸŸ */
        .slot-bar {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 20;
        }

        /* ä¸‹æ–¹æ§½ä½ */
        #slot-container {
            position: relative;
            width: 380px;
            height: 70px;
            background: var(--slot-bg);
            backdrop-filter: blur(10px);
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 15px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 5px;
            box-sizing: border-box;
        }

        .slot-tile {
            width: 45px;
            height: 45px;
            background: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            animation: bounceIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* æ¸¸æˆåŒºåŸŸ */
        #game-container {
            position: relative;
            width: 560px;
            height: 520px;
            margin-top: 16px;
            z-index: 10;
        }

        .tile {
            position: absolute;
            width: 50px;
            height: 50px;
            background: var(--tile-bg);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px #ccc, 0 8px 15px rgba(0,0,0,0.3);
            transition: all 0.2s;
            user-select: none;
            border: 2px solid transparent;
        }

        .tile.disabled {
            filter: brightness(0.5);
            cursor: not-allowed;
            pointer-events: none;
        }

        .tile:active {
            transform: translateY(2px);
            box-shadow: 0 2px #ccc, 0 4px 10px rgba(0,0,0,0.3);
        }

        @keyframes bounceIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* æç¤ºä¸é®ç½© */
        .overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: #fff;
        }

        button {
            padding: 10px 30px;
            font-size: 1.2rem;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 20px;
        }

        button:hover { transform: scale(1.1); }

        /* é›ªèŠ±èƒŒæ™¯ */
        .snow-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .snowflake {
            position: absolute;
            color: white;
            font-size: 1.2rem;
            animation: fall linear infinite;
        }

        @keyframes fall {
            to { transform: translateY(105vh) rotate(360deg); }
        }
    </style>
</head>
<body>

    <div class="snow-container" id="snow"></div>

    <button id="restart-btn" class="restart-btn restart-btn-fixed">é‡æ–°å¼€å§‹</button>

    <h1>ğŸ¦Šç‹äº†ä¸ªç‹—ğŸ¶</h1>
    <div class="hud">
        <div class="score">åˆ†æ•°ï¼š<span id="score">0</span></div>
        <div class="level-tag">å…³å¡ï¼š<span id="level-label">1</span>/2</div>
    </div>

    <div id="game-container"></div>

    <div class="slot-bar">
        <div id="slot-container"></div>
        <button id="tool-btn" class="tool-btn">é“å…·ï¼šè¿”è¿˜æ§½ä½</button>
    </div>

    <div class="overlay" id="overlay">
        <h2 id="result-text">æ¸¸æˆç»“æŸ</h2>
        <button id="overlay-next" style="display:none;">ä¸‹ä¸€å…³</button>
        <button id="overlay-restart">å†ç©ä¸€æ¬¡</button>
    </div>

    <script>
        const ICONS = ['ğŸ¦Š', 'ğŸ¶', 'ğŸ…', 'ğŸ„', 'ğŸ', 'ğŸ””', 'ğŸ¦Œ', 'â„ï¸', 'ğŸª', 'ğŸ•¯ï¸', 'ğŸ§¤', 'ğŸ­'];
        const LEVELS = [
            {
                name: 'ç¬¬ä¸€å…³',
                icons: ['ğŸ¶', 'ğŸ¦Š', 'ğŸ„'],
                layers: [
                    { rows: 3, cols: 3, offsetX: 205, offsetY: 140, zIndex: 1 }
                ]
            },
            {
                name: 'ç¬¬äºŒå…³',
                icons: ICONS,
                layers: [
                    // å·¦ä¾§å°å †
                    { rows: 3, cols: 2, offsetX: 30, offsetY: 140, zIndex: 1 },
                    { rows: 2, cols: 2, offsetX: 45, offsetY: 170, zIndex: 2 },
                    // ä¸­å¤®ä¸»å †
                    { rows: 5, cols: 5, offsetX: 150, offsetY: 40, zIndex: 1 },
                    { rows: 4, cols: 4, offsetX: 175, offsetY: 70, zIndex: 2 },
                    { rows: 3, cols: 3, offsetX: 200, offsetY: 100, zIndex: 3 },
                    { rows: 2, cols: 2, offsetX: 225, offsetY: 130, zIndex: 4 },
                    // å³ä¾§å°å †
                    { rows: 3, cols: 2, offsetX: 410, offsetY: 140, zIndex: 1 },
                    { rows: 2, cols: 2, offsetX: 395, offsetY: 170, zIndex: 2 }
                ]
            }
        ];

        const TILE_WIDTH = 50;
        const TILE_HEIGHT = 50;
        const SLOT_MAX = 7;
        const SCORE_PER_TILE = 10;
        
        let allTiles = [];
        let slot = [];
        let score = 0;
        let currentLevel = 0; // 0-based index for LEVELS
        let toolUsed = false;
        
        const gameContainer = document.getElementById('game-container');
        const slotContainer = document.getElementById('slot-container');
        const overlay = document.getElementById('overlay');
        const scoreElem = document.getElementById('score');
        const levelLabel = document.getElementById('level-label');
        const restartBtn = document.getElementById('restart-btn');
        const overlayRestart = document.getElementById('overlay-restart');
        const overlayNext = document.getElementById('overlay-next');
        const toolBtn = document.getElementById('tool-btn');

        // 1. åˆå§‹åŒ–é›ªèŠ±
        function createSnow() {
            const snow = document.getElementById('snow');
            snow.innerHTML = '';
            for(let i=0; i<50; i++) {
                const div = document.createElement('div');
                div.className = 'snowflake';
                div.innerHTML = 'â„';
                div.style.left = Math.random() * 100 + 'vw';
                div.style.animationDuration = (Math.random() * 3 + 2) + 's';
                div.style.opacity = Math.random();
                snow.appendChild(div);
            }
        }

        function updateScore() {
            scoreElem.textContent = score;
        }

        function updateLevelLabel() {
            levelLabel.textContent = currentLevel + 1;
        }

        function resetToolState() {
            toolUsed = false;
            toolBtn.disabled = false;
            toolBtn.textContent = 'é“å…·ï¼šè¿”è¿˜æ§½ä½';
        }

        function resetGame() {
            score = 0;
            currentLevel = 0;
            overlay.style.display = 'none';
            overlayNext.style.display = 'none';
            allTiles = [];
            slot = [];
            updateScore();
            resetToolState();
            initLevel(currentLevel);
        }

        // é“å…·ï¼šå°†æ§½ä½é‡Œçš„å¡ç‰‡è¿”è¿˜åˆ°ä¸Šæ–¹ä¸€å­—æ’å¼€ï¼ˆæ¯å…³ä»…ä¸€æ¬¡ï¼‰
        function useReturnTool() {
            if (toolUsed) return;
            if (!slot.length) return;
            toolUsed = true;
            toolBtn.disabled = true;
            toolBtn.textContent = 'é“å…·å·²ç”¨å®Œ';

            const startX = 10;
            const gap = 55;
            const posY = 10;
            slot.forEach((tile, idx) => {
                tile.status = 0;
                tile.x = startX + idx * gap;
                tile.y = posY;
                tile.zIndex = 1;
            });
            slot = [];
            renderBoard();
            renderSlot();
        }

        function buildTilePool(levelCfg) {
            const { layers, icons } = levelCfg;
            const totalCells = layers.reduce((sum, l) => sum + l.rows * l.cols, 0);
            const groups = Math.floor(totalCells / 3);
            const pool = [];
            for (let i = 0; i < groups * 3; i++) {
                pool.push(icons[Math.floor(i / 3) % icons.length]);
            }
            pool.sort(() => Math.random() - 0.5);
            return pool;
        }

        // åˆå§‹åŒ–æŸå…³å¡
        function initLevel(levelIdx) {
            const levelCfg = LEVELS[levelIdx];
            if (!levelCfg) return;
            slot = [];
            allTiles = [];
            gameContainer.innerHTML = '';
            slotContainer.innerHTML = '';
            overlay.style.display = 'none';
            overlayNext.style.display = 'none';
            updateLevelLabel();
            resetToolState();

            const tilePool = buildTilePool(levelCfg);
            let count = 0;

            levelCfg.layers.forEach(layer => {
                for(let r=0; r<layer.rows; r++) {
                    for(let c=0; c<layer.cols; c++) {
                        if(count >= tilePool.length) break;
                        const tile = {
                            id: count,
                            icon: tilePool[count],
                            x: c * (TILE_WIDTH + 5) + layer.offsetX,
                            y: r * (TILE_HEIGHT + 5) + layer.offsetY,
                            zIndex: layer.zIndex,
                            status: 0 // 0: åœ¨åœºä¸Š, 1: åœ¨æ§½ä½, 2: å·²æ¶ˆé™¤
                        };
                        allTiles.push(tile);
                        count++;
                    }
                }
            });

            renderBoard();
        }

        // 3. æ¸²æŸ“æ¸¸æˆé¢æ¿
        function renderBoard() {
            gameContainer.innerHTML = '';
            allTiles.forEach(tile => {
                if(tile.status !== 0) return;

                const div = document.createElement('div');
                div.className = 'tile';
                div.innerHTML = tile.icon;
                div.style.left = tile.x + 'px';
                div.style.top = tile.y + 'px';
                div.style.zIndex = tile.zIndex + 10; // ä¿è¯åœ¨é›ªèŠ±ä¹‹ä¸Š

                // æ£€æµ‹æ˜¯å¦è¢«è¦†ç›–
                const isCovered = allTiles.some(other => {
                    return other.status === 0 && 
                           other.zIndex > tile.zIndex &&
                           Math.abs(other.x - tile.x) < TILE_WIDTH * 0.8 &&
                           Math.abs(other.y - tile.y) < TILE_HEIGHT * 0.8;
                });

                if(isCovered) {
                    div.classList.add('disabled');
                } else {
                    div.onclick = () => moveToSlot(tile);
                }

                gameContainer.appendChild(div);
            });
        }

        // 4. ç‚¹å‡»ç§»åŠ¨åˆ°æ§½ä½
        function moveToSlot(tile) {
            if (slot.length >= SLOT_MAX) return;

            tile.status = 1;
            slot.push(tile);
            
            // æ’åºæ§½ä½ï¼Œæ–¹ä¾¿æ¶ˆé™¤åˆ¤æ–­
            slot.sort((a, b) => {
                const iconA = ICONS.indexOf(a.icon);
                const iconB = ICONS.indexOf(b.icon);
                return iconA - iconB;
            });

            // æ£€æŸ¥ä¸‰æ¶ˆ
            const countMap = {};
            slot.forEach(item => countMap[item.icon] = (countMap[item.icon] || 0) + 1);
            
            let gainedTiles = 0;
            for(const icon in countMap) {
                if(countMap[icon] >= 3) {
                    // æ¶ˆé™¤
                    slot = slot.filter(item => {
                        if(item.icon === icon) {
                            item.status = 2;
                            return false;
                        }
                        return true;
                    });
                    gainedTiles += countMap[icon];
                }
            }

            if (gainedTiles > 0) {
                score += gainedTiles * SCORE_PER_TILE;
                updateScore();
            }

            renderBoard();
            renderSlot();
            checkGameState();
        }

        // 5. æ¸²æŸ“æ§½ä½
        function renderSlot() {
            slotContainer.innerHTML = '';
            slot.forEach(tile => {
                const div = document.createElement('div');
                div.className = 'slot-tile';
                div.innerHTML = tile.icon;
                slotContainer.appendChild(div);
            });
        }

        // 6. èƒœè´Ÿåˆ¤æ–­
        function checkGameState() {
            const activeTiles = allTiles.filter(t => t.status === 0);
            if(activeTiles.length === 0 && slot.length === 0) {
                if (currentLevel < LEVELS.length - 1) {
                    showResult(`${LEVELS[currentLevel].name}å®Œæˆï¼è¿›å…¥ä¸‹ä¸€å…³`, true);
                } else {
                    showResult("åœ£è¯å¿«ä¹ï¼ä½ èµ¢äº†ï¼ğŸ", false);
                }
            } else if(slot.length >= SLOT_MAX) {
                showResult("æ§½ä½æ»¡äº†ï¼Œå†æ¥å†å‰ï¼ğŸ…", false);
            }
        }

        function showResult(text, hasNext) {
            document.getElementById('result-text').innerText = text;
            overlay.style.display = 'flex';
            overlayNext.style.display = hasNext ? 'inline-block' : 'none';
        }

        function goNextLevel() {
            if (currentLevel < LEVELS.length - 1) {
                currentLevel += 1;
                overlay.style.display = 'none';
                overlayNext.style.display = 'none';
                initLevel(currentLevel);
            }
        }

        restartBtn.addEventListener('click', resetGame);
        overlayRestart.addEventListener('click', resetGame);
        overlayNext.addEventListener('click', goNextLevel);
        toolBtn.addEventListener('click', useReturnTool);

        // å¯åŠ¨
        createSnow();
        initLevel(currentLevel);
    </script>
</body>
</html>
